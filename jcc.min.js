jQuery.fn.jcc_findAndSelf=function(a){return this.find(a).add(this.filter(a))};function printDebug(a){(console)?console.log(a):alert(a)}var JccBundle=function(b,a,c){this.index=b;this.blueprintNode=a;this.visibleNode=c};var jccDictionary=function(e,d,c,b,a){this.dictionary=e;this.dictionaryName=d;this.node=c;b=(b=="")?null:b;this.alias=b||d;a=(a=="")?null:a;this.enumVar=a||this.alias+"_index"};jccDictionary.prototype={isNamed:function(a){return(this.dictionaryName==a||this.alias==a)}};var jccDictionaryStack=function(){this.__dictionaries=[];jccDictionary.apply(this,[null,null,null,null,null])};jccDictionaryStack.prototype={push:function(e,d,c,b,a){this.__dictionaries.push(new jccDictionary(e,d,c,b,a));this.refresh()},pop:function(){this.__dictionaries.pop();this.refresh()},refresh:function(){if(this.__dictionaries!=null&&this.__dictionaries.length>0){var a=this.__dictionaries[this.__dictionaries.length-1];jccDictionary.apply(this,[a.dictionary,a.dictionaryName,a.node,a.alias,a.enumVar])}else{jccDictionary.apply(this,[null,null,null,null,null])}},peek:function(){if(this.__dictionaries!=null&&this.__dictionaries.length>0){return this.__dictionaries[this.__dictionaries.length-1]}else{return null}},getDictionaryIndexByName:function(b){for(var a=this.__dictionaries.length-1;a>=0;a--){if(this.__dictionaries[a].alias==b||this.__dictionaries[a].dictionaryName==b){return a}}return -1},getDictionaryByIndex:function(a){if(a>=0&&a<this.__dictionaries.length){return this.__dictionaries[a]}return null},getDefinition:function(j,c,a){var b=(a==-1)?this.__dictionaries.length-1:a;var g=(a==-1)?0:a;try{if(a==-1){var h=this.getDictionaryIndexByName(c);if(h!=-1){return this.__dictionaries[h].dictionary[j]}}for(var d=b;d>=g;d--){if(typeof(this.__dictionaries[d].dictionary[j][c])!="undefined"){return this.__dictionaries[d].dictionary[j][c]}else{var k=this.__dictionaries[d].enumVar;if(k==c){return j+1}}}}catch(f){return f}return"undefined!"},isEmpty:function(){return(this.__dictionaries==0)}};var jccCompactRangesArray=function(g){if(!g||g.length==0){return g}g.sort(function(j,i){return j[0]-i[0]});var c=new Array();var d=g[0][0],a=g[0][1];var e,b;for(var f=1;f<g.length;++f){var h=g[f];e=h[0];b=h[1];if(e<=a+1){if(b>=a){a=b}continue}c.push([d,a]);d=e;a=b}c.push([d,a]);return c};var jccIndexFilterFactory=function(h){var a;var k,j,d,f;var o=new RegExp(/^\s*(?:repeat|all)\s*$/i);var c=new RegExp(/^\s*(?:none\s*)?$/i);var l=new RegExp(/^\s*(even[s]?)\s*$/i);var g=new RegExp(/^\s*(odd[s]?)\s*$/i);var n=new RegExp(/^\s*\d+\s*(?:[-]\s*\d+\s*)?(?:[,]\s*\d+\s*(?:[-]\s*\d+\s*)?)*$/);var b=new RegExp(/^\s*(\d+)\s*(?:[-]\s*(\d+)\s*)?$/);var m=false,e=h.match(/^\s*not\s*\(([^\)]+)\)\s*$/i);if(e!==null){m=true;h=e[1]}if(o.test(h)){return function(){return !m}}if(c.test(h)){return function(){return m}}if(l.test(h)){return function(i){return i%2==0?!m:m}}if(g.test(h)){return function(i){return i%2==1?!m:m}}if(n.test(h)){a=h.split(",");for(f=0;f<a.length;++f){d=b.exec(a[f]);if(d){k=parseInt(d[1]);j=((d[2]!==undefined)&&(d[2]!==""))?parseInt(d[2]):k;a[f]=(k<j)?[k,j]:[j,k]}else{printDebug("filter range is not well-defined")}}a=jccCompactRangesArray(a);return function(p){var r=false;for(var q=0;q<a.length;++q){if(p>=a[q][0]){if(p<=a[q][1]){r=true;break}}else{break}}return(m)?!r:r}}else{return new Function("return "+h+";").call(window)}};var jcc=function(){this.dictStack=new jccDictionaryStack();this.preHandlers={};this.postHandlers={};this.widgetHandlers={};this.bundleTable=[];this.widgetTable=[];this.jccPermanentAttr=[];this.preInit();this.tempIdMapping={}};jcc.setCharAt=function(c,a,b){if(a>c.length-1){return c}return c.substr(0,a)+b+c.substr(a+1)};jcc.nodeIndexCounter=1;jcc.widgetIndexCounter=1;jcc.CONSTANTS={HANDLER_TYPES:{PRE_HANDLER:0,POST_HANDLER:1,WIDGET:2},CLONED_NODE_ID_PREFIX:"jcc__",CLONED_NODE_CLASS:"jccClonedElement",VISIBLE_NODE_CLASS:"jccVisibleElement"};jcc.prototype={registerHandler:function(b,c,a){if(b&&c&&(!isNaN(a))){var d=null;switch(a){case jcc.CONSTANTS.HANDLER_TYPES.PRE_HANDLER:d=this.preHandlers;break;case jcc.CONSTANTS.HANDLER_TYPES.POST_HANDLER:d=this.postHandlers;break;case jcc.CONSTANTS.HANDLER_TYPES.WIDGET:d=this.widgetHandlers;break;default:d=null;break}if(d!=null){d["jcc:"+b.toLowerCase()]=c}}else{printDebug("Error: registerHandler received bad parameters.")}},refresh:function(c,d,a){var b=this;window.setTimeout(function(){b.refreshFunc(c,d,a)},10)},refreshFunc:function(b,h,f){var e=this;var a=typeof b;var c=[];var d=null;if(b!=null&&a!="undefined"){if(a=="string"){var i=$("#"+b);c.push(i)}else{if(a=="object"){var i;var g;if(b instanceof Array){$.each(b,function(j,k){if(typeof k=="string"){i=$("#"+k)}else{i=$(k)}c.push(i)})}else{c.push($(b))}}}}else{$(".jcc").each(function(){c.push($(this))})}if(h){d=new Array()}$.each(c,function(m,o){var p=e.getJccNodeAttribute(o.get(0),"nodeindex");var l=e.getJccNodeAttribute(o.get(0),"parentwidgetindex");window.clearTimeout(o.attr("jccTimeout"));if(p){if(l&&e.widgetTable[l].refreshFunc){e.widgetTable[l].refreshFunc.apply(window,[o])}else{o.remove()}var j=e.bundleTable[p].blueprintNode;if(f){f(j)}var n=(j.clone().insertAfter($("#jcc_node_"+p)))[0];e.bundleTable[p].visibleNode=e.recurse.apply(e,[n]);var k=$(e.bundleTable[p].visibleNode);if(k.html().indexOf("#{=")!=-1){e.replaceLiterals.apply(e,[k])}if(d!=null){d.push(n)}}else{printDebug("Error: Trying to refresh node with no jcc:nodeindex attribute.")}});if(h){h.call(window,d)}},preInit:function(){this.registerHandler("repeat",this.handleRepeat,jcc.CONSTANTS.HANDLER_TYPES.PRE_HANDLER);this.registerHandler("data",this.handleData,jcc.CONSTANTS.HANDLER_TYPES.PRE_HANDLER);this.registerHandler("runOnce",this.handleRunOnce,jcc.CONSTANTS.HANDLER_TYPES.PRE_HANDLER);this.registerHandler("callback",this.handleNothing,jcc.CONSTANTS.HANDLER_TYPES.POST_HANDLER);this.registerHandler("tempid",this.handleTempID,jcc.CONSTANTS.HANDLER_TYPES.POST_HANDLER);this.registerHandler("timeout",this.handleTimeout,jcc.CONSTANTS.HANDLER_TYPES.POST_HANDLER);this.registerHandler("table",this.handleWidgetTable,jcc.CONSTANTS.HANDLER_TYPES.WIDGET);this.registerHandler("form",this.handleWidgetForm,jcc.CONSTANTS.HANDLER_TYPES.WIDGET)},init:function(){this.jccPermanentAttr.push("jcc:nodeindex");this.jccPermanentAttr.push("jcc:parentwidgetindex");this.handleNodes()},handleNodes:function(){var a=this;$(".jccWidget").each(function(){var c=jcc.widgetIndexCounter++;$(this).attr("jcc:nodeindex",c);var b={};b.blueprint=this;a.widgetTable[c]=b;a.handleWidget.apply(a,[this,c]);$(this).remove()});$(".jcc").each(function(){var d=jcc.nodeIndexCounter++;$(this).attr("jcc:nodeindex",d);var b=a.clone.apply(a,[this,d]);$(this).jcc_findAndSelf("*[id]").each(function(){$(this).attr("jcc:tempid",$(this).attr("id"));$(this).removeAttr("id")});var e=a.recurse.apply(a,[this]);var c=$(e);if(c.html().indexOf("#{=")!=-1){a.replaceLiterals.apply(a,[$(e)])}a.bundleTable[d]=new JccBundle(d,b,e)})},handleWidget:function(e,d){var f=e.tagName.toLowerCase();if(f.search(/^jcc:/)!=0){f="jcc:"+f}var c=$(e).attr("jcc:refresh");if(c){var a=new Function("var jccRefreshFunc = "+c+"; return jccRefreshFunc;");a=a();this.widgetTable[d].refreshFunc=a}if(typeof(this.widgetHandlers[f.toLowerCase()])!="undefined"){var b=this.widgetHandlers[f.toLowerCase()].apply(this,[e]);if(b){b=$(b);b.attr("jcc:parentwidgetindex",d);$(e).after(b)}}},clone:function(d,b){var c=$(d);var a=c.clone();$("<jcc:placeholder id='jcc_node_"+b+"' />").insertBefore(c);return a},recurse:function(a){var c=this;var b=null;this.handleAttributes.apply(this,[a,this.preHandlers]);$.each($(a).children(),function(e,d){c.recurse.apply(c,[d])});b=this.handleAttributes.apply(this,[a,this.postHandlers]);this.removeJccAttr.apply(this,[$(a)]);if(a===this.dictStack.node){this.dictStack.pop()}if(b!=null){this.execFunc(b,window,[a])}return a},handleAttributes:function(e,f){var b=null;if(e.attributes!==null){var a=false;var c=null;var d=this;$.each(e.attributes,function(h,k){if(k!==undefined){var g=k.name.toLowerCase();var j=k.value;if(g.search(/^jcc:/)==0){if(f[g]!==undefined){if(g=="jcc:repeat"){a=true;c=j}else{if(g=="jcc:callback"){b=j}else{f[g].apply(d,[e,j]);if(g=="jcc:runonce"){$(e).attr("jcc:runonce","")}}}}}}});if(a){f["jcc:repeat"].apply(d,[e,c])}}return b},execFunc:function(c,b,a){b=b||window;a=a||[];var f;try{f=new Function("var f=null; try {f= "+c+";} finally {return f;}");f=f.apply(window,a);if(typeof f=="function"){f=f.apply(b,a)}}catch(d){printDebug("Function failed with error: "+d)}return f},replaceLiteralsHelper:function(j){j=j.replace(/%7B/,"{");j=j.replace(/%7D/,"}");j=j.replace(/\[\]\./g,"@");var b=/#\{([^}]*)\}/i;while(j.indexOf("#{")!=-1){var h=j.match(b);if((h!=null)&&(h.length>1)){var a=$.trim(h[1]);if(a.length==0){continue}var f=-1;var k=null;if(h[1].charAt(0)!="="){if(!this.dictStack.isEmpty()){var d=a.indexOf(".");if(d!=-1){var c=a.match(/^([^\.]+)\..+/);if(c!=null&&c.length>1){var i=c[1];f=this.dictStack.getDictionaryIndexByName(i)}}if(f!=-1){h[1]=h[1].substr(d+1,h[1].length);dicIndex=this.dictStack.getDictionaryByIndex(f).currentRow}else{dicIndex=this.dictStack.peek().currentRow}k=this.dictStack.getDefinition(dicIndex,h[1],f)}}else{a=a.substr(1)}if(k===null){try{k=this.execFunc(a,window)}catch(g){k=g}}j=j.replace(b,k)}}return j},replaceLiterals:function(b){var a=this;$.each(b.get(0).attributes,function(f,h){var e=h.name;var g=h.value;if((g!="null")&&(g!="")){var j=a.replaceLiteralsHelper.apply(a,[g]);if(j!==g){b.attr(e,j)}}});var c=b.html();var d=this.replaceLiteralsHelper(c);if(d!==c){b.html(d)}},removeJccAttr:function(a){var c=this;var b=[];$.each(a.get(0).attributes,function(e,f){if(typeof(f)!="undefined"){var d=f.name;if(d.search(/^jcc:/)==0){if(($.inArray(d,c.jccPermanentAttr)==-1)){b.push(d)}}}});$.each(b,function(e,d){a.removeAttr(d)})},getJccNodeAttribute:function(d,c){var b=new RegExp("^jcc:"+c);var a=null;$.each(d.attributes,function(f,g){if(typeof(g)!="undefined"){var e=g.name;if(e.search(b)==0){a=g.value;return}}});return a},handleData:function(o,d){var x=undefined;var n=new RegExp(/^\s*(\w+)\s*=\s*(.*)\s*$/);var f=new RegExp(/^\s*(http[s]*[:]\/\/\S+)\s*$/i);var g="data";if(d.match(/^\s*(\w*(\[\]\.|\.))*\w*\s*$/)){d=d.replace(/\[\]\./g,"@");g=d;if(d.indexOf("@")!=-1){var j=d.indexOf("@");var l=d;var v="";while(j!=-1){var a=l.substring(0,j);l=l.substring(j+1,l.length);var i=this.dictStack.getDictionaryIndexByName(v+a);if(i!=-1){var w=this.dictStack.getDictionaryByIndex(i).currentRow;d=d.replace("@","["+w+"].");v+=a+"@";j=l.indexOf("@")}else{printDebug("dictionary with name '"+v+a+"' is not defined.")}}}x=this.execFunc(d,window);var t=x!==undefined&&x!==null;if(!t){if(this.dictStack.peek()){x=this.dictStack.getDefinition(this.dictStack.peek().currentRow,g,-1);if(typeof x=="object"){}}}}else{if(n.test(d)){var p=n.exec(d);g=p[1];d=p[2];if(f.test(d)){var p=f.exec(d);var c=p[1];var q=false;var b={url:c,async:false,dataType:"json",complete:function(){q=true},success:function(e){x=e}};$.ajax(b);while(!q){}}else{var u=p[2].replace(/[']([\s\w]*)[']/g,'"$1"');x=$.parseJSON(u)}}else{if(d.match(/^\s*.*\([^\)]*\)\s*$/)){var r=this.execFunc(d,window);if(typeof r=="object"){x=r}else{printDebug(d+" function didn't return an object for use as a dictionary")}}}}if(x===undefined){try{x=this.execFunc(d,window)}catch(s){printDebug("Can't figure out what to to with data element "+d)}}var k;var h;try{k=$(o).attr("jcc:alias");h=$(o).attr("jcc:enumerate")}catch(s){k=this.getJccNodeAttribute(o,"alias");h=this.getJccNodeAttribute(o,"enumerate")}this.dictStack.push(x,g,o,k,h)},handleRepeat:function(d,f){var c=$(d);var a;var b=this;var e=jccIndexFilterFactory(f);if(typeof this.dictStack.dictionary=="object"){$.each(this.dictStack.dictionary,function(g,h){if(!e(g,h)){return}a=c.clone();b.dictStack.peek().currentRow=g;a.insertBefore(c);a.removeAttr("jcc:repeat");b.recurse.apply(b,[a.get(0)]);b.replaceLiterals.apply(b,[a])})}else{printDebug("dictionary with name '"+this.dictStack.dictionaryName+"' is not defined.")}c.remove()},handleTempID:function(a,b){idCount=this.tempIdMapping[b];if(typeof idCount!="undefined"){if(idCount==1){$("#"+b).attr("id",b+"_1")}b=b+"_"+(++this.tempIdMapping[b])}else{this.tempIdMapping[b]=1}$(a).attr("id",b)},handleRunOnce:function(a,b){if(b){this.execFunc(b,window)}},handleTimeout:function(b,c){if(c){jl=this;var a=function(){jl.refresh(b)};b.jccTimeout=window.setTimeout(a,c)}},handleNothing:function(a){},handleWidgetTable:function(e){var f=$(e);var o;var n=this;var a=this.getJccNodeAttribute(e,"data");var c=this.getJccNodeAttribute(e,"id");var b=this.getJccNodeAttribute(e,"class");var d=this.getJccNodeAttribute(e,"callback");var p=this.getJccNodeAttribute(e,"filter");var j=this.getJccNodeAttribute(e,"tablehead");var l=null;if(p){l=new jccIndexFilterFactory(p)}if(a){var h=(new Function("return "+a)).call(window);var k=0;if(h.length>0&&h[0].length>0){k=h[0].length}var m="";m+='\n<table class="jcc';if(b){m+=" "+b}m+='"';m+='jcc:data="'+a+'" ';if(c){m+='id="'+c+'" '}if(d){m+='jcc:callback="'+d+'" '}m+='border="1">\n';if(j){j=(new Function("return "+j)).call(window);if(typeof j=="object"){m+="\t<thead>\n\t\t<tr";if(c){m+=' id="'+c+'_h_tr" '}m+=">\n";for(var g=0;g<k;g++){if(l==null||l(g)){m+="\t\t\t<th";if(c){m+=' id="'+c+'_th" '}m+=">"+(j[g]?j[g]:"")+"</th>\n"}}m+="\n\t\t</tr>\n\t</thead>\n"}}m+='\t<tbody>\n\t\t<tr jcc:repeat="repeat"';if(c){m+=' id="'+c+'_b_tr" '}m+=">\n";for(var g=0;g<k;g++){if(l==null||l(g)){m+="\t\t\t<td";if(c){m+=' id="'+c+'_td" '}m+=">#{"+g+"}</td>\n"}}m+="\t\t</tr>\n\t</tbody>\n</table>";return m}},handleWidgetForm:function(e){var f=$(e);var m;var l=this;var h=this.getJccNodeAttribute(e,"struct");var c=this.getJccNodeAttribute(e,"id");var a=this.getJccNodeAttribute(e,"class");var d=this.getJccNodeAttribute(e,"callback");var b=function(i){k="";if(i){$.each(i,function(n,o){k+=n+'="'+o+'" '})}return k};if(h){h=(new Function("return "+h)).call(window);if(typeof h=="object"){var k="";k+='\n<form class="jcc';if(a){k+=" "+a}k+='"';if(c){k+='id="'+c+'" '}if(h.action){k+='action="'+h.action+'" '}if(h.method){k+='method="'+h.method+'" '}if(d){k+='jcc:callback="'+d+'" '}k+=">\n";k+="<fieldset>";if(h.legend){k+="<legend>"+h.legend+"</legend>"}k+="<ol>";if(typeof h.fields=="object"){var g;for(var j=0;j<h.fields.length;j++){g=h.fields[j];k+="<li><label>"+g.text+"</label> <input ";k+=b(g.attributes);k+=" /></li>\n"}}k+="</ol>";k+='<input type="submit" ';if(h.submit){k+=b(h.submit)}k+="/>";k+="</fieldset>";k+="</form>";return $(k)}}}};window.jccLib=new jcc();$(document).ready(function(){jccLib.init()});